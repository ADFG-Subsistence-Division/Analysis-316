---
title: "A05_MARGIN_NOTES - (316) NPS Ambler Comprehensive"
author: "Jesse Coleman"
date: "2025-08-15"
output:
  html_document:
    theme: null
    css: ../HTML/adfg-style.css
    include:
      before_body: ../HTML/header.html
      after_body: ../HTML/footer.html
---
<div class="title-container">
  <img class="title-logo" src="../HTML/adfg_logo.png" alt="ADFG Logo"/>
  <div class="title">A05_MARGIN_NOTES - (316) NPS Ambler Comprehensive</div>
</div>

# Get margin notes

Extract margin notes to pass back to SRS staff writing up the findings.

## Changelog
- Programmer: D.S.Koster  
- Date: 05/21/2024  
- Change Description: Updated organization and formatting to be more consistent and provide better feedback/output.  
- Template Update [Y|N]: Y  
- One-Off: No-include in all future comprehensive templates 

## Input data  
  
- /CSV/00 - Lookup Codes/fullCommuntyList.csv  
- /CSV/00 - Lookup Codes/surveyPageInfo_raw.csv  
- dfgjnusql-db71p/Sub_SDS.dbo.DAT_MARGIN_NOTE  
- dfgjnusql-db71p/Sub_SDS.dbo.DAT_HH_CONTROLLER  

## Output data  
  
- /CSV/03 - Main/marginNotes_raw.csv  

## Background Information

## Checklist

- Update 'Author' to your name   
- Update the project information in 'title' to the current project  
- Update the development log with any changes you've made to the template file, including your name  
- Each margin note evaluated and survey reviewed
- Verify that margin notes have been correctly entered for v1

## Additional information

Write implementation notes here.

### Required libraries  

- tidyVerse  
- odbc  
- rio  
- knitr  

```{r setup, echo=FALSE}

# Set some knit options and functions for formatting data.
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = TRUE)
knitr::opts_chunk$set(results='asis')

options(knitr.kable.NA = '')

```

# Data processing

## Initialize environment

```{r initalize environment}

# Clear out all existing variables & datasets.
rm(list=ls(all=TRUE))
library(knitr)

# Include the project parameters file - this needs to be updated for all 
#   projects.
source('../Z00_PROJECT_PARAMETERS.r')
source('../Functions/f_RMD_HTML_FORMATTING_FUNCTIONS.r')

# For this particular script, we need to include the ODBC Connections.
source('../Functions/f_subsistenceDatabaseConnections.r')

# Note project information
cat(str_interp('<p class="rbn">Working on project ${projID} ${projectName} - ${studyear}</p>'))

```

```{r initiate server connection}

# 1.1 Load the ODBC Library 
loadODBCLibrary()

```

## Load lookup data

```{r extract community codes}

commListData <- read.csv('../../CSV/00 - Lookup Codes/fullCommuntyList.csv',
            na = '', header = TRUE, strip.white = TRUE)
count <- nrow(commListData)
cat(formatSummaryBlock(paste("Loading file: fullCommuntyList.csv, ", 
                             count, 
                             " records loaded.", sep="")))

surveyPageData <- read.csv('../../CSV/00 - Lookup Codes/surveyPageInfo_raw.csv',
            na = '', header = TRUE, strip.white = TRUE)
count <- nrow(surveyPageData)
cat(formatSummaryBlock(paste("Loading file: surveyPageInfo_raw.csv, ", 
                             count, 
                             " records loaded.", sep="")))
```

## Extract margin notes from SDS

```{r extract sticky notes}

# Open a connection.
conn = connectToSDS()

# Get Sampling
strSQL = sql(str_interp('SELECT [marginNoteID]
      ,hc.[projID]
      ,hc.[studyear]
      ,hc.[communty]
      ,hc.[HHID]
	  ,hc.version
      ,[pgNum]
      ,[pageName]
      ,[marginNote]
      ,[addedBy]
      ,[addedDate]
  FROM [Sub_SDS].[dbo].[DAT_MARGIN_NOTE] mn
  LEFT JOIN [Sub_SDS].[dbo].[DAT_HH_CONTROLLER] hc
  ON mn.HHControlID = hc.HHControlID 
  WHERE (hc.projID = ${projID} AND hc.studyear = ${studyear})'))

marginFullData <- odbc::dbGetQuery(conn, strSQL)

count <- nrow(marginFullData)
cat(formatSummaryBlock(paste("Extracted SQL: ", strSQL, "; ", 
                             count, 
                             " records loaded.", sep="")))

# Close server connection.
dbDisconnect(conn)

```

## Margin Note Reports

*NOTE:* Verify that margin notes have been correctly entered for v1.

If you receive a warning describing many-to-many relationships, you may need to verify that the margin notes are correctly captured. There should be only 1 per page.

```{r margin notes table}

marginFullData <- left_join(marginFullData,
                            surveyPageData,
                            by=c('projID',
                                 'studyear',
                                 'communty',
                                 'pgNum'='pageNum')) %>%
  filter(!is.na(marginNote))

marginFullKey <- distinct(marginFullData, projID, studyear, communty, HHID, pgNum,
                          recordTypeCD, recordType, recordTypeDetailDesc)

marginV1Data <- filter(marginFullData, version == 1) %>%
  select(projID, studyear, communty, HHID, pgNum,
         version, marginNote) %>%
  rename(v1 = version,
         v1MarginNote = marginNote)

marginV2Data <- filter(marginFullData, version == 2) %>%
  select(projID, studyear, communty, HHID, pgNum,
         version, marginNote) %>%
  rename(v2 = version,
         v2MarginNote = marginNote)

marginCheckData <- left_join(marginFullKey, marginV1Data,
                             by=c('projID', 'studyear', 'communty', 'HHID', 'pgNum'))
marginCheckData <- left_join(marginCheckData, marginV2Data,
                             by=c('projID', 'studyear', 'communty', 'HHID', 'pgNum'))

if(nrow(marginV1Data) != nrow(marginV2Data)){
  cat(errorMessage(str_interp('Version 1 margin notes have ${nrow(marginV1Data)} and version 2 margin notes have ${nrow(marginV2Data)} - please verify V1 contains ALL margin notes before proceeding!')))
}

knitr::kable(marginCheckData, 
             caption=formatTableHeader("V1/V2 margin Notes"),
             align='l')

```


# Write CSV files

```{r write csv files}

# ##############################################################################
# Write out CSV files.
# ##############################################################################

marginNotesOutData <- filter(marginFullData, version == 1)

  cat(formatSummaryBlock(
    paste('Writing file: ',
          '../../CSV/03 - Main/marginNotes_raw.csv', 
          sep='')))

  rio::export(marginNotesOutData, '../../CSV/03 - Main/marginNotes_raw.csv')


```


<p class="h1footer"> End of Margin Notes script. </p>

