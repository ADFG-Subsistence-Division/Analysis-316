---
title: "F06_SELECTED_FINDINGS - (316) NPS Ambler Comprehensive"
author: "Jesse Coleman"
date: "2025-08-15"
output:
  html_document:
    theme: null
    css: ../HTML/adfg-style.css
    include:
      before_body: ../HTML/header.html
      after_body: ../HTML/footer.html
---
<div class="title-container">
  <img class="title-logo" src="../HTML/adfg_logo.png" alt="ADFG Logo"/>
  <div class="title">F06_SELECTED_FINDINGS - (316) NPS Ambler Comprehensive</div>
</div>

# Selected findings

Produce a summary of selected findings for comparison and evaluation.

## Change log

### Change 1
- Programmer: D.S.Koster  
- Date: 05/21/2024  
- Change Description: Updated organization and formatting to be more consistent and provide better feedback/output. Incorporated Gini coefficient for 70-30  
- Template Update [Y|N]: Y  
- One-Off: No-include in all future comprehensive templates 

### Change 2
- Programmer: Jesse Coleman
- Date: 03/18/2025
- Change Description: Removed source() calls; all functions are included in the library adfgSubs.
- Template Update [Y|N]: Y
- One-Off: No-include in all future comprehensive templates 

## Input data
  
- /CSV/03 - Main/REC01_clean.csv  
- /CSV/05 - Final Analysis Output/demogCharacteristics(T)_raw.csv  
- /CSV/05 - Final Analysis Output/ethnic_compare(T)_raw.csv  
- /CSV/05 - Final Analysis Output/employCharacteristics(T)_raw.csv  
- /CSV/05 - Final Analysis Output/birthPlaceOfHHHeads_raw.csv  
- /CSV/05 - Final Analysis Output/estEarnedAndOtherIncome_raw.csv  
- /CSV/05 - Final Analysis Output/Gini_raw.csv  
- /CSV/03 - Main/harvData_HH_finalPrepped.csv  
- /CSV/03 - Main/sample.csv  

## Output data
  
- /CSV/05 - Final Analysis Output/comparisons_raw(T).csv  

## Checklist
  
- Update 'Author' to your name  
- Update the project information in 'title' to the current project  
- Update the development log with any changes you've made to the template file, including your name  
- Create the table from the table templates  
- Verify that all data presented from this .html file matches the table  

## Additional information

This file relies on outputs from across the analysis categories. This file cannot be run until after the rest of the analysis has been run and generally evaluated.

### Functions used/dependencies

### Required libraries
  
- tidyVerse  
- rio  
- knitr  
- kableExtra
- adfgSubs


```{r setup, echo=FALSE}

# Set some knit options and functions for formatting data.
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = TRUE)
knitr::opts_chunk$set(results='asis')

options(knitr.kable.NA = '')

```

# Data processing

## Initialize environment

```{r initalize environment}

# Clear out all existing variables & datasets.
rm(list=ls(all=TRUE))

# Additional libraries
library(knitr)
library(kableExtra)
library(adfgSubs)

# Include the project parameters file - this needs to be updated for all 
#   projects.
source('../Z00_PROJECT_PARAMETERS.r')
# source('../Functions/f_RMD_HTML_FORMATTING_FUNCTIONS.r')

# Standard functions
# source('../Functions/f_manageVariables.r')

# Note project information
cat(str_interp('<p class="rbn">Working on project ${projID} ${projectName} - ${studyear}</p>'))

```

## Load data

```{r load data}

# ##############################################################################
# Load data from intermediate files.
# ##############################################################################

personData <- read.csv('../../CSV/03 - Main/REC01_clean.csv',
                       na = '',
                       header = TRUE,
                       strip.white = TRUE)
count <- nrow(personData)
cat(formatSummaryBlock(paste("Opening file: REC01_clean.csv, ", 
                             count, 
                             " records loaded.", sep="")))

demogCharData <- read.csv('../../CSV/05 - Final Analysis Output/demogCharacteristics(T)_raw.csv',
                          na='',
                          header = TRUE,
                          strip.white=TRUE)
count <- nrow(demogCharData)
cat(formatSummaryBlock(paste("Opening file: demogCharacteristics(T)_raw.csv, ", 
                             count, 
                             " records loaded.", sep="")))

ethnicCompData <- read.csv('../../CSV/05 - Final Analysis Output/ethnic_compare(T)_raw.csv',
                           na='',
                           header = TRUE,
                           strip.white=TRUE)
count <- nrow(ethnicCompData)
cat(formatSummaryBlock(paste("Opening file: ethnic_compare(T)_raw.csv, ", 
                             count, 
                             " records loaded.", sep="")))

emplCharData <- read.csv('../../CSV/05 - Final Analysis Output/employCharacteristics(T)_raw.csv',
                         na='',
                         header = TRUE,
                         strip.white=TRUE)
count <- nrow(emplCharData)
cat(formatSummaryBlock(paste("Opening file: employCharacteristics(T)_raw.csv, ", 
                             count, 
                             " records loaded.", sep="")))

birthPlHHHeadData <- read.csv('../../CSV/05 - Final Analysis Output/birthPlaceOfHHHeads_raw.csv',
                              na='',
                              header = TRUE,
                              strip.white=TRUE)
count <- nrow(birthPlHHHeadData)
cat(formatSummaryBlock(paste("Opening file: birthPlaceOfHHHeads_raw.csv, ", 
                             count, 
                             " records loaded.", sep="")))

incData <- read.csv('../../CSV/05 - Final Analysis Output/estEarnedAndOtherIncome_raw.csv',
                    na='',
                    header = TRUE,
                    strip.white=TRUE)
count <- nrow(incData)
cat(formatSummaryBlock(paste("Opening file: estEarnedAndOtherIncome_raw.csv, ", 
                             count, 
                             " records loaded.", sep="")))

harvData <- read.csv('../../CSV/03 - Main/harvData_HH_finalPrepped.csv',
                     na = '',
                     header = TRUE,
                     strip.white = TRUE)
count <- nrow(harvData)
cat(formatSummaryBlock(paste("Opening file: harvData_HH_finalPrepped.csv, ", 
                             count, 
                             " records loaded.", sep="")))

#Load and limit Gini data.
GiniData <- read.csv('../../CSV/05 - Final Analysis Output/Gini_raw.csv',
                     na = '',
                     header = TRUE,
                     strip.white = TRUE) %>%
  filter(rank == 1) %>%
  select(projID, studyear, communty, giniCoefLorenz) %>% 
  rename(Gini = giniCoefLorenz)

count <- nrow(GiniData)
cat(formatSummaryBlock(paste("Opening file: Gini_raw.csv, ", 
                             count, 
                             " records loaded.", sep="")))

sampData <- read.csv('../../CSV/03 - Main/sample.csv',
                     na = '',
                     header = TRUE,
                     strip.white = TRUE)
count <- nrow(sampData)
cat(formatSummaryBlock(paste("Opening file: sample.csv, ", 
                             count, 
                             " records loaded.", sep="")))

# Calculate household size per household for necessary stats later on.
hhSizeData <- group_by(personData, projID, studyear, communty, strata, HHID) %>%
  summarize(hhSize = n())

```
## Automation lists

lists to improve the process of building tables.

```{r automation lists}

tableLabels <- c(
	'Population',
	'Percentage of population that is Alaska Native',
	'Percentage of household heads born in Alaska',
	'Average length of residency of household heads (year)',

	'Average number of months employed',
	'Percentage of employed adults working year-round',
	'Percentage of income from sources other than employment',
	'Average household incomea',
	'Per capita incomea',
	
	'Per capita harvest, pounds usable weight',
	'Average household harvest, pounds usable weight',
	'Number of resources used by 50% or more households',
	'Average number of resources used per household',
	'Average number of resources attempted to be harvested per household',
	'Average number of resources harvested per household',
	'Average number of resources received per household',
	'Average number of resources given away per household',
	'Percentage of total harvest taken by top 25% ranked households',
	'Percentage of households that harvested 70% of harvest',
	'Gini coefficient for total household harvest',
	'Per capita harvest by lowest ranked 50% of households',
	'Percentage of total harvest taken by lowest ranked 50% of harvesting households',
	'Average number of resources used by lowest ranked 50% of households',
	'Average number of resources used by top 25% ranked households')


```

## Selected demographic findings

```{r selected demographics}

# Pct AK Native.
ethnicCompData$pctAkNative = ethnicCompData$akNative_sum / ethnicCompData$NPopulation

# HH Head born in AK
birthPlHHHeadData <- group_by(birthPlHHHeadData, projID, studyear, communty) %>%
  filter(birthPlace < 901) %>%
  summarize(pctHeadsBornAK = sum(pctBirthPlace, na.rm=TRUE))

# Length of residency of household heads.hhHeadLenRes
demogCharData <- select(demogCharData, 
                        projID, studyear, communty, yrcomcat_HHHead_mean)

demogData <- select(ethnicCompData, projID, studyear, 
         communty, commname, NHouseholds, NPopulation, pctAkNative) %>%
  left_join(birthPlHHHeadData, by=c("projID", "studyear", "communty")) %>%
  left_join(demogCharData, by=c("projID", "studyear", "communty"))

```

## Cash economy findings

Be sure to check the results of this information against the employment and income tables and figures.

```{r cash economy findings}

incData <- filter(incData, incCategoryDesc %in% c("All income sources",
                                                  "All industries",
                                                  "All other sources of income")) %>%
           select(projID, studyear, communty, incCategoryDesc, estIncome)

# Relabel categories
incData$incCategoryDesc[incData$incCategoryDesc == "All income sources"] = "totalIncome"
incData$incCategoryDesc[incData$incCategoryDesc == "All industries"] = "earnedIncome"
incData$incCategoryDesc[incData$incCategoryDesc == "All other sources of income"] = "otherIncome"

# Pivot data
incData <- pivot_wider(incData, names_from=incCategoryDesc,
                        values_from = estIncome)

# For 'mean months employed' - we will use "per adult".
emplCharData <- select(emplCharData, projID, studyear, communty, commname,
                       NHouseholds, NPopulation, 
                       weeksEmployedAllAdults,
                       pctAdultEmplYrRound)
# Convert to months.
emplCharData$meanMonthsWorked = (emplCharData$weeksEmployedAllAdults / 52) * 12

emplCharData <- left_join(emplCharData, incData, by=c("projID","studyear","communty"))

emplCharData$pctIncomeFromOther = 0
emplCharData$pctIncomeFromOther = emplCharData$otherIncome / emplCharData$totalIncome
emplCharData$meanHHIncome = emplCharData$totalIncome / emplCharData$NHouseholds
emplCharData$perCapIncome = emplCharData$totalIncome / emplCharData$NPopulation

incSummaryData <- select(emplCharData, projID, studyear, communty,
                         meanMonthsWorked,
                         pctAdultEmplYrRound,
                         pctIncomeFromOther,
                         meanHHIncome,
                         perCapIncome)

```

## Selected harvest findings

Be sure to check this information agains the harvest and use tables and figures.

```{r selected harvest findings}

lbsSummaryData <- filter(harvData, resource == 0) %>%
  group_by(projID, studyear, communty, NHouseholds, NPopulation) %>%
  summarize(estHarvestLbs = sum(estHarvestLbs))

lbsSummaryData$percap = lbsSummaryData$estHarvestLbs / lbsSummaryData$NPopulation
lbsSummaryData$meanHHHarv = lbsSummaryData$estHarvestLbs / lbsSummaryData$NHouseholds

lbsSummaryData <- delete_variables(lbsSummaryData, c("NHouseholds", "NPopulation", "estHarvestLbs"))

# Used by 50% or more households; make sure to adjust for stratified samples.
nResUsedData <- filter(harvData, specList == 1) %>%
  group_by(projID, studyear, communty, NHouseholds, resource) %>%
  summarize(nUsed = sum(used * strataWt, na.rm=TRUE))

nResUsedData$pctUsing = nResUsedData$nUsed / nResUsedData$NHouseholds

nResUsedData$nResGT50pct = 0
nResUsedData$nResGT50pct[nResUsedData$pctUsing >= .5] = 1

nResUsedData <- summarize(nResUsedData, nResGT50pct = sum(nResGT50pct, na.rm=TRUE))

nResUsedData <- delete_variables(nResUsedData, c("NHouseholds", "NPopulation"))

# Mean activity; make sure to adjust for stratified samples.
meanHHActivityData <- filter(harvData, specList == 1) %>% 
  group_by(projID, studyear, communty, NHouseholds) %>%
  summarize(nUsed = sum(used * strataWt, na.rm=TRUE),
            nAttempt = sum(attempt * strataWt, na.rm=TRUE),
            nHarvestq = sum(harvestq * strataWt, na.rm=TRUE),
            nReceived = sum(received * strataWt, na.rm=TRUE),
            nGiveaway = sum(giveaway * strataWt, na.rm=TRUE))

meanHHActivityData$meanUsed = meanHHActivityData$nUsed / meanHHActivityData$NHouseholds
meanHHActivityData$meanAttempt = meanHHActivityData$nAttempt / meanHHActivityData$NHouseholds
meanHHActivityData$meanHarvestq = meanHHActivityData$nHarvestq / meanHHActivityData$NHouseholds
meanHHActivityData$meanReceived = meanHHActivityData$nReceived / meanHHActivityData$NHouseholds
meanHHActivityData$meanGiveaway = meanHHActivityData$nGiveaway / meanHHActivityData$NHouseholds

meanHHActivityData <- ungroup(meanHHActivityData) %>%
  select(projID, studyear, communty, meanUsed, meanAttempt, meanHarvestq, meanReceived, meanGiveaway)

# Overall resource only for this.

rankData <- filter(harvData, resource == 0) %>%
  group_by(projID, studyear, communty) %>%
  mutate(harvRankASC = order(order(estHarvestLbs)))

rankData <- arrange(rankData, projID, studyear, communty, desc(estHarvestLbs)) %>%
  group_by(projID, studyear, communty) %>%
  mutate(nRecords = n(),
         totalHarv = sum(estHarvestLbs, na.rm=TRUE),
         csum = cumsum(estHarvestLbs))

rankData$pctCSum = rankData$csum / rankData$totalHarv

rankData <- left_join(rankData, hhSizeData, by=c("projID", "studyear", "communty", "strata", "HHID"))

rankData$diff70 = abs(0.7 - rankData$pctCSum)

rankData <- group_by(rankData, projID, studyear, communty) %>%
  mutate(diff70Rank = order(order(diff70)))


rankData$pctRankASC = rankData$harvRankASC / rankData$nRecords
rankData$pctRankDesc = ((1 + rankData$nRecords) - rankData$harvRankASC) / rankData$nRecords

pctTop25Data <- filter(rankData, pctRankDesc <= .25) %>%
  group_by(projID, studyear, communty, totalHarv) %>%
  summarize(amtTop25 = sum(estHarvestLbs, na.rm=TRUE))

pctTop25Data$pctTop25 = pctTop25Data$amtTop25 / pctTop25Data$totalHarv

pctTop25Data <- delete_variables(pctTop25Data, c("amtTop25", "totalHarv"))

pctHH70TakeData <- filter(rankData, diff70Rank == 1) %>% 
  select(projID, studyear, communty, pctRankDesc)

pctHH70TakeData$pctHHsTake70pctHarv = pctHH70TakeData$pctRankDesc
pctHH70TakeData <- delete_variables(pctHH70TakeData, c("pctRankDesc"))

low50HarvData <- filter(rankData, pctRankASC <= .5) %>%
  group_by(projID, studyear, communty, totalHarv) %>%
  summarize(groupPop = sum(hhSize * strataWt, na.rm=TRUE),
            low50HarvAmt = sum(estHarvestLbs, na.rm=TRUE))

low50HarvData$low50percap = low50HarvData$low50HarvAmt / low50HarvData$groupPop
low50HarvData$pctlow50Total = low50HarvData$low50HarvAmt / low50HarvData$totalHarv

low50HarvData <- select(low50HarvData, projID, studyear, communty, low50percap, pctlow50Total)
  
hhRankData <- select(rankData, projID, studyear, communty, strata, HHID, pctRankASC)

harvData <- left_join(harvData, hhRankData, by=c("projID", "studyear", "communty", "strata", "HHID"))

low50nResources = filter(harvData, specList == 1 & pctRankASC <= 0.5) %>%
  group_by(projID, studyear, communty, strata, HHID) %>%
  summarize(nRecords = max(strataWt), 
           nUsed = sum(used * strataWt, na.rm=TRUE)) %>%
  group_by(projID, studyear, communty) %>%
  summarize(nRecords = sum(nRecords),
            nUsed = sum(nUsed, na.rm=TRUE))

low50nResources$meanUsedLow50 = low50nResources$nUsed / low50nResources$nRecords

low50nResources <- select(low50nResources, projID, studyear, communty, meanUsedLow50)

high25nResources <- filter(harvData, specList == 1 & pctRankASC >= 0.75) %>%
  group_by(projID, studyear, communty, strata, HHID) %>%
  summarize(nRecords = max(strataWt), 
            nUsed = sum(used * strataWt, na.rm=TRUE)) %>%
  group_by(projID, studyear, communty) %>%
  summarize(nRecords = sum(nRecords),
            nUsed = sum(nUsed, na.rm=TRUE))

high25nResources$meanUsedHigh25 = high25nResources$nUsed / high25nResources$nRecords

high25nResources <- select(high25nResources, projID, studyear, communty, meanUsedHigh25)

```

## Merge selected findings

```{r merge selected findings}

joinbyList <- c("projID", "studyear", "communty")

summaryData <- left_join(demogData, incSummaryData, by=joinbyList) %>%
  left_join(lbsSummaryData, by=joinbyList) %>%
  left_join(nResUsedData, by=joinbyList) %>%
  left_join(meanHHActivityData, by=joinbyList) %>%
  left_join(pctTop25Data, by=joinbyList) %>%
  left_join(pctHH70TakeData, by=joinbyList) %>%
  left_join(GiniData, by=joinbyList) %>%
  left_join(low50HarvData, by=joinbyList) %>%
  left_join(low50nResources, by=joinbyList) %>%
  left_join(high25nResources, by=joinbyList)


tmpTableData <- select(summaryData,
                       -projID, -studyear, -communty, -NHouseholds)
# Do a bunch of formatting now.
tmpTableData <- mutate(tmpTableData, across(starts_with('pct'), ~ . * 100))
tmpTableData <- mutate(tmpTableData, across(all_of(names(select(tmpTableData, -commname, -Gini))), ~ round(.,1)))
#tmpTableData <- mutate(tmpTableData, across(all_of(names(select(Gini))), ~ round(.,3)))
tmpTableData$Gini = round(tmpTableData$Gini, 3)
tmpTableData <- mutate(tmpTableData, across(all_of(names(tmpTableData)), ~ as.character(.)))
tmpTableData <- mutate(tmpTableData, across(starts_with('pct'), ~ paste(.,'%',sep='')))

tmpTableData <- pivot_longer(tmpTableData, cols=names(select(tmpTableData, -commname)), 
                             names_to = 'column', values_to='value') %>%
  pivot_wider(id_cols='column', names_from='commname', values_from = 'value')

tmpTableData <- select(tmpTableData, -column)
tmpTableData <- data.frame("Category" = tableLabels, tmpTableData)

# Formatting rows.
tmpTableData <- tmpTableData %>% add_row(Category="Demography", .before=1)
tmpTableData <- tmpTableData %>% add_row(Category="Cash economy", .before=6)
tmpTableData <- tmpTableData %>% add_row(.before=6)
tmpTableData <- tmpTableData %>% add_row(Category="Resource harvest and use", .before=13)
tmpTableData <- tmpTableData %>% add_row(.before=13)

tblOut <- kbl(tmpTableData, digits=2,
              caption=formatTableHeader(str_interp("Harvest and use characteristics, ${studyear}"))) %>%
              kable_styling(full_width = F) %>%
      row_spec(c(1,7,14),bold=T,hline_after = T) %>%
      add_indent(c(2,3,4,5,8,9,10,11,12,
                   15,16,17,18,19,20,21,
                   22,23,24,25,26,27,28))
print(tblOut)

```


# Write CSV files

```{r write csv files}

# ##############################################################################
# Write out CSV files.
# ##############################################################################

# write selected findings table.
  fName = '../../CSV/05 - Final Analysis Output/comparisons_raw(T).csv'
  cat(formatSummaryBlock(
    paste('Writing file: ', fName, 
          ' ', nrow(summaryData), ' records to be written', sep='')))

  rio::export(summaryData, fName)

```

<p class="h1footer"> End of Selected findings script. </p>

