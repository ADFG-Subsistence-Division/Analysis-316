---
title: "E04_BIRD_HARVEST_BY_SEASON - (316) NPS Ambler Comprehensive"
author: "Jesse Coleman"
date: "2025-08-15"
output:
  html_document:
    theme: null
    css: ../HTML/adfg-style.css
    include:
      before_body: ../HTML/header.html
      after_body: ../HTML/footer.html
---
<div class="title-container">
  <img class="title-logo" src="../HTML/adfg_logo.png" alt="ADFG Logo"/>
  <div class="title">E04_BIRD_HARVEST_BY_SEASON - (316) NPS Ambler Comprehensive</div>
</div>

# Harvest season (birds)

Create output files to import into the bird harvest by season table.

## Change log

### Change 1
- Programmer: D.S.Koster  
- Date: 05/21/2024  
- Change Description: Update organization and formatting to be more consistent and provide better feedback/output. Addressed an issue with deprecated dplyr code. 
- Template Update [Y|N]: Y  
- One-Off: No-include in all future comprehensive templates  

### Change 2
- Programmer: D.S.Koster  
- Date: 07/22/2024  
- Change Description: Corrected inconsistency with table displaying data and reordered both table and figure to reflect the template table. 
- Template Update [Y|N]: Y  
- One-Off: No-include in all future comprehensive templates  

### Change 3
- Programmer: Jesse Coleman
- Date: 03/18/2025
- Change Description: Removed source() calls; all functions are included in the library adfgSubs.
- Template Update [Y|N]: Y
- One-Off: No-include in all future comprehensive templates 

## Input data
  
- /CSV/03 - Main/harvData_HH_finalPrepped.csv  

## Output data
  
- /CSV/06 - Final Analysis Output/harvest_by_season_raw.csv  

### Background

### Checklist
  
- Update 'Author' to your name
- Update the project information in 'title' to the current project
- Update the development log with any changes you've made to the template file, including your name  
- Update template tables with data produced  
- Compare template tables you created with outputs here  

## Additional information

This file uses a substantial level of automation, please be sure to verify that all columns necessary for harvest by season are included.  Prior to this version of the analysis code, seasons were combined with month and sex. To provide a more maintainable codeset these have been split up. Now mammal harvest timing tables will be produced in:  
E03_HARVEST_BY_MONTH_SEX.Rmd  

### Required libraries

- tidyVerse  
- rio  
- knitr  
- kableExtra
- adfgSubs

```{r setup, echo=FALSE}

# Set some knit options and functions for formatting data.
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = TRUE)
knitr::opts_chunk$set(results='asis')

options(knitr.kable.NA = '')

```

# Data processing

## Initialize environment

```{r initalize environment}

# Clear out all existing variables & data sets.
rm(list=ls(all=TRUE))

# Additional libraries
library(knitr)
library(kableExtra)
library(adfgSubs)

# Include the project parameters file - this needs to be updated for all 
#   projects.
source('../Z00_PROJECT_PARAMETERS.r')

# Note project information
cat(str_interp('<p class="rbn">Working on project ${projID} ${projectName} - ${studyear}</p>'))


```

## Load data

Load only birds & nestlings.  

```{r load data}

# ##############################################################################
# Load data from intermediate files.
# ##############################################################################

# This for each file opened.
harvData <- read.csv('../../CSV/03 - Main/harvData_HH_finalPrepped.csv',
                   na = '', 
                   header = TRUE, 
                   strip.white = TRUE)

count <- nrow(harvData)
cat(formatSummaryBlock(paste("Opening file: harvData_HH_finalPrepped.csv, ", 
                             count, 
                             " records loaded.", sep="")))

# Produce 2 data frames one for the output table and one for figures

# Filter harvest data.
harvData$catCode = floor(harvData$resource / 10000000)
figData <- filter(harvData, resource %in% c(410200000, 
                                           410400000,
                                           410600000,
                                           410800000,
                                           411000000,
                                           411200000,
                                           411400000,
                                           421800000,
                                           440000000,
                                           422000000,
                                           490000000))

# Just bird categories.
#harvData <- filter(harvData, catCode %in% c(41, 42, 44, 49))
harvData <- filter(harvData, specList == 1 & between(resource, 400000000, 499999999))


count <- count - nrow(harvData)
cat(formatSummaryBlock(str_interp("harvData_HH_finalPrepped.csv has been filtered to relevant rows only, ${count} rows removed.")))


```

## Lists for Automation

```{r automation lists}

harvCols = standardBirdColumns

commnameList <- select(harvData, commname) %>% distinct(commname)
selResCat <- select(figData, resName) %>% distinct(resName)


seasonOrderData <- data.frame(season=harvCols, seasonCD=as.factor(c(1,2,3,4,5)))

```


## Non-expansion

```{r non expanded resources}

aData <- filter(harvData, !! rlang::parse_expr(noExpansionCriteria))
bData <- filter(harvData, !! rlang::parse_expr(noExpansionCriteriaNot))

if(nrow(aData) > 0) {
  aData$strataWt = 1
  
  harvData <- dplyr::bind_rows(aData, bData) %>% 
    arrange(projID, studyear, communty, strata, resource)
  
  tempData <- distinct(aData, commname, resName)

  print(knitr::kable(tempData, 
               caption=formatTableHeader("Resources not expanded.")))
} else {
  cat(greenMessage("All included resources are expanded."))
}

rm(aData, bData)

```

## Summarize

```{r produce summaries, message=FALSE}


# Expand harvest columns according to strata weight.
harvTimingData <- mutate_at(harvData, vars(all_of(harvCols)), ~ . * strataWt)

# Summarize from HH level to resource level.
harvTimingData <- group_by(harvTimingData, projID, studyear, communty, commname, 
                     NHouseholds, NPopulation, resource, resName) %>%
  summarize(estHarvestAmt=sum(estHarvestAmt, na.rm=TRUE), 
            estHarvestLbs=sum(estHarvestLbs, na.rm=TRUE), 
            across(all_of(harvCols), \(harv) sum(harv, na.rm=TRUE))) %>%
  ungroup()

# 2.10 - Clean up white space.
harvTimingData$resName = trimws(harvTimingData$resName, which=c("both"))

# Remove eggs.
harvTimingData <- filter(harvTimingData, resource < 430000000 | resource >= 440000000)

```

## Review output

### Harvest of birds

Harvests of birds, except bird eggs. Box and whisker plots are produced below for only resources harvested and only households harvesting. This illustrated when and the overall take by household. For example, if the box covers a range of 10-20 birds during the winter, then 50% of households are harvesting at this level. The line on the box-plot is the median take by harvesting households.

```{r review outputs bird by season}

for(comm in commnameList$commname)
{
  tmpTblData <- filter(harvTimingData, commname == comm) %>%
    select(resName, !!!syms(harvCols), estHarvestAmt)
  
  tmpTblData <- mutate_at(tmpTblData, vars(all_of(c(harvCols, "estHarvestAmt"))), ~ round(., 1))
  
  tblOut <- kbl(tmpTblData,
        caption=formatTableHeader(str_interp("Harvests of birds by season ${comm}, ${studyear}")),
        col.names=c("Resource",
                    "Spring",	"Summer", "Fall",	"Winter","Unk",
                   "Total")) %>%
      kable_styling(full_width = F) %>%
      add_header_above(c("  " = 1, "Estimated harvest" = 5, 
                         "  " = 1))
  
  print(tblOut)
  
  tmpTblData <- rowwise(tmpTblData) %>%
                  mutate(seasonHarv = sum(across(all_of(harvCols)), na.rm=TRUE))
  
  tmpTblData$checkAmt <- tmpTblData$estHarvestAmt - tmpTblData$seasonHarv

  tmpTblData <- select(tmpTblData, resName, estHarvestAmt, seasonHarv, checkAmt) %>%
    filter(checkAmt > .0001)
  
  if(nrow(tmpTblData) > 0) {
    tblOut <- kbl(tmpTblData,
        caption=formatTableHeader(str_interp("Error in sum of seasons for birds: ${comm}, ${studyear}")),
        col.names=c("Resource",
                   "Estimated total",
                   "Sum of seasons",
                   "Difference")) %>%
      kable_styling(full_width = F) %>%
      add_header_above(c("  " = 1, "Estimated harvest" = 3))
    print(tblOut)
    
  } else {
      cat(greenMessage("All harvest month columns sum to total column for birds."))
  }
  
  # box plot for certain categories of bird.
  
  # Box plots by category
  
  # Only plot resources with harvests.
  plotData <- filter(figData, commname == comm) %>%
    select(resName, !!!syms(harvCols))
  
  if(nrow(plotData) > 0)
  {
    for(res in selResCat$resName)
    {
      plotTempData <- filter(plotData, res == resName) %>%
                      rowwise() %>%
                  mutate(seasonHarv = sum(across(all_of(harvCols)), na.rm=TRUE)) %>%
        group_by(resName) %>%
                  mutate(seasonHarv_max = max(seasonHarv, na.rm=TRUE)) %>%
        filter(seasonHarv_max > 0 & seasonHarv > 0)
      
      plotTempData <- select(plotTempData, -seasonHarv, -seasonHarv_max)
      
      if(nrow(plotTempData) > 0)
      {
          # This only works because we don't need the community name at this point.
          plotTempData <- pivot_longer(plotTempData, cols=all_of(harvCols), names_to="season")
          plotTempData <- plotTempData %>% 
                          left_join(seasonOrderData, by=c("season"))
          
          plotOut <- ggplot(plotTempData,        # Create ggplot2 boxplot
                aes(x = seasonCD,
                    y = value)) +
            geom_boxplot() +
            xlab("Season") +
            ylab("Household harvest") +
            scale_x_discrete(labels=c("Spring",	"Summer", "Fall",	"Winter",	"Unknown")) +            
            ggtitle(str_interp("Harvest of ${res} by season, ${comm}, ${studyear} - Harvesting households only")) +
            theme(text=element_text(family="serif")) +
            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                  panel.background = element_blank(), axis.line = element_line(colour = "black"))
    
          print(plotOut)
      }
    }
  }
  
}

```


## Write out CSV files

```{r write csv files}

# ##############################################################################
# Write out CSV files.
# ##############################################################################

# Write out bird harvests by season script
  fName = '../../CSV/05 - Final Analysis Output/bird_harvest_by_season_raw.csv'
  cat(formatSummaryBlock(
    paste('Writing file: ', fName, 
          ' ', nrow(harvTimingData), ' records to be written', sep='')))

  rio::export(harvTimingData, fName)

```

<p class="h1footer"> End of bird harvest by season script. </p>
