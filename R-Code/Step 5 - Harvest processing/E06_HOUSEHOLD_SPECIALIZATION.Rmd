---
title: "E06_HOUSEHOLD_SPECIALIZATION - (316) NPS Ambler Comprehensive"
author: "Jesse Coleman"
date: "2025-08-15"
output:
  html_document:
    theme: null
    css: ../HTML/adfg-style.css
    include:
      before_body: ../HTML/header.html
      after_body: ../HTML/footer.html
---
<div class="title-container">
  <img class="title-logo" src="../HTML/adfg_logo.png" alt="ADFG Logo"/>
  <div class="title">E06_HOUSEHOLD_SPECIALIZATION - (316) NPS Ambler Comprehensive</div>
</div>

# Household specialization

Produce the input data for the specialization figures.

## Change log

### Change 1
- Programmer: D.S.Koster  
- Date: 05/21/2024  
- Change Description: Updated organization and formatting to be more consistent and provide better feedback/output. Added calculation of Gini coefficient.  
- Template Update [Y|N]: Y  
- One-Off: No-include in all future comprehensive templates  

### Change 2
- Programmer: Jesse Coleman
- Date: 03/19/2025
- Change Description: Removed source() calls; all functions are included in the library adfgSubs. Also removed hand-calculated Gini coefficient code. The adfgSubs library has two methods to calculate Gini coefficients. Added annotation to specialization curve plot with Gini coefficient (mean absolute difference).
- Template Update [Y|N]: Y
- One-Off: No-include in all future comprehensive templates 

### Change 3
- Programmer: Jesse Coleman
- Date: 07/11/2025
- Change Description: Refactor using tidyverse language and DRY ("don't repeat 
yourself") principles.
- Template Update [Y|N]: Y
- One-Off: No - include in all future comprehensive templates 

## Input data
  
- /CSV/03 - Main/harvData_HH_finalPrepped.csv 
- /CSV/03 - Main/REC01_clean.csv  

## Output data
  
- /CSV/05 - Final Analysis Output/specializationFig_raw.csv  
- ../../CSV/05 - Final Analysis Output/Gini_raw.csv  

## Background

A well documented and recognized feature of subsistence economies is 'specialization'. This was originally described by Bob Wolfe as the 70-30 rule. This information depicts something about the number of 'super-harvesters' in the community. A very extreme specialization curve, for example 70-10 or 70-5 where perhaps 10 or 5 percent of households produce 70% of subsistence harvests indicates extreme specialization and may imply concerns related to resilience. If only one harvester is engaged in sockeye salmon fishing and they take the vast majority of harvests for the community, the loss of that single fisher may represent a substantial potential hardship for the community.  

Further, this pattern can help guide understanding during regulatory matters. These high-harvesters are very important, and limiting their access to resources has the potential of an outsized impact on the community that may lead to increased hunting or fishing pressure thereby confounding the intent of regulatory decisions.  

## Checklist
  
- Update 'Author' to your name  
- Update the project information in 'title' to the current project  
- Update the development log with any changes you've made to the template file, including your name  

## Additional information

### Required libraries (adjust as needed)

- tidyverse  
- rio  
- knitr  
- kableExtr
- adfgSubs

```{r setup, echo=FALSE}

# Set some knit options and functions for formatting data.
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = TRUE)
knitr::opts_chunk$set(results='asis')

options(knitr.kable.NA = '')

```

# Data processing

## Initialize environment

```{r initalize environment}

# Clear out all existing variables & datasets.
rm(list=ls(all=TRUE))

# Additional libraries
library(knitr)
library(kableExtra)
library(adfgSubs)

# Include the project parameters file - this needs to be updated for all 
#   projects.
source('../Z00_PROJECT_PARAMETERS.r')

# Note project information
cat(str_interp('<p class="rbn">Working on project ${projID} ${projectName} - ${studyear}</p>'))

```

## Load data

```{r load data}

# Load data from intermediate files.

# Load working data file.
harvData <- read.csv('../../CSV/03 - Main/harvData_HH_finalPrepped.csv', 
                      na = '', 
                      header = TRUE, 
                      strip.white = TRUE) 
count <- nrow(harvData)
cat(formatSummaryBlock(paste("Opening file: harvData_HH_finalPrepped.csv, ", 
                             count, 
                             " records loaded.", sep="")))

# Household size
hhSizeData <- read.csv('../../CSV/03 - Main/REC01_clean.csv',
                       na = '',
                       header = TRUE,
                       strip.white = TRUE) %>%
  group_by(projID, studyear, communty, strata, HHID) %>%
  summarize(hhSize = n())

count <- nrow(hhSizeData)
cat(formatSummaryBlock(paste("Opening file: REC01_clean.csv - data summarized and reduced to ", 
                             count, 
                             " records for hhSize.", sep="")))


```
## Gini Coefficients

```{r calculate Gini coefficients}

 # Create the anonymous function
gini_calc <- function(COMMNAME, data) {
  
  # Calculate gini coefficients first
  giniMAD <- gini_mad(data %>% 
                      filter(resource == 0 & commname == COMMNAME) %>% 
                      pull(estHarvestLbs))
  
  giniLorenzArea <- gini_lorenz(data %>% 
                               filter(resource == 0 & commname == COMMNAME) %>% 
                               pull(estHarvestLbs))
  
  # Main calculation
  data %>% 
    filter(resource == 0 & commname == COMMNAME) %>%
    select(projID:NHouseholds, estHarvestLbs) %>%
    group_by(across(-estHarvestLbs)) %>%
    arrange(estHarvestLbs) %>%
    mutate(
      rank = row_number(),
      cumPropEstHarvLbs = cumsum(estHarvestLbs)/sum(estHarvestLbs),
      cumPropHH = rank / samphh,
      lorenzArea = (cumPropEstHarvLbs + lag(cumPropEstHarvLbs, default = 0)) *
        (cumPropHH - lag(cumPropHH, default = 0))/2,
      giniCoefLorenz = giniLorenzArea,
      giniCoefMAD = giniMAD
    )
}

# Map the function across unique community names

giniAllData <- unique(harvData$commname) %>%
  map_dfr(~ gini_calc (.x, harvData)) %>% 
  ungroup()


# Produce kable for HTML

tblOut <- kbl(giniAllData %>% 
                filter(rank == 1) %>% 
                select(commname, giniCoefMAD, giniCoefLorenz),
      caption=formatTableHeader(str_interp("Gini Coefficients")),
      col.names=c("Community", "Gini (MAD)", "Gini (Lorenz)")) %>%
    kable_styling(full_width = F)
  
print(tblOut)


```

## Specialization

Produce the data frame required as input for the excel specialization figures.

```{r produce specialization data}

commnameList <- select(harvData, commname) %>% distinct(commname)

# Overall resource only for this, also note stratification has already been
#   addressed.

rankData <- filter(harvData, resource == 0) %>%
  group_by(projID, studyear, communty) %>%
  mutate(harvRankASC = order(order(estHarvestLbs))) %>% 
  arrange(projID, studyear, communty, desc(estHarvestLbs)) %>%
  group_by(projID, studyear, communty) %>%
  mutate(nRecords = n(),
         totalHarv = sum(estHarvestLbs, na.rm=TRUE),
         cHarv = cumsum(estHarvestLbs),
         pctcHarv = cHarv/totalHarv) %>% 
  # Join to household size data
  left_join(hhSizeData, by=c("projID", "studyear", "communty", "strata", "HHID")) %>% 
  mutate(diff70 = abs(0.7 - pctcHarv)) %>% 
  group_by(projID, studyear, communty) %>%
  mutate(diff70Rank = order(order(diff70)),
         pctRankASC = harvRankASC / nRecords,
         cPctHHs = ((1 + nRecords) - harvRankASC) / nRecords,
         yaxis = if_else(diff70Rank == 1, pctcHarv, NA),
         xaxis = if_else(diff70Rank == 1, cPctHHs, NA)
  )


figData <- rankData %>% 
  select(projID, studyear, communty, commname, HHID,
                   estHarvestLbs, totalHarv, cHarv, pctcHarv, cPctHHs,
                   yaxis, xaxis) %>%
  left_join(giniAllData %>%
              filter(rank == 1) %>%
              select(commname, giniCoefMAD, giniCoefLorenz),
            by = "commname") %>%
  arrange(projID, communty, cHarv, cPctHHs)

```

## Specialization figures

```{r specialization figures}

for(comm in commnameList$commname)
{
  tmpFigData <- filter(figData, commname == comm)
  
  hhTaking = round(max(tmpFigData$xaxis, na.rm=TRUE) * 100, 0)
  amtTaking = round(max(tmpFigData$yaxis, na.rm=TRUE) * 100, 0)
  labelText = paste(hhTaking, "% households harvested \n",
                    amtTaking, "% of total pounds harvested.",
                    sep="")
  
  plotOut <- ggplot(tmpFigData, aes(x=cPctHHs, y=pctcHarv)) +
  ggtitle(str_interp("Specialization for: ${comm}, ${studyear}")) +
    annotate("segment", x=0, xend = 1, y=0, yend=1, 
                   color="#3288bd", linetype = "dashed") +
    annotate("text", x=.84, y=.75, col="#3288bd", 
               label="Equal \n harvests") +
    annotate("text", x=.75, y = .2,
             label = paste0("Gini coefficient = ", round(tmpFigData$giniCoefMAD[1],2))) +
    geom_line(col="#f46d43", linewidth=1) +
    geom_point(aes(x=xaxis, y=yaxis), col="black", 
               fill="#3288bd", size=5, shape=1) +
    annotate("text", x=.5, y=.5, label=labelText) +
    annotate("segment", x = hhTaking/100, xend = .33, y = amtTaking/100, yend = .5,
             color = "black") +
    xlab("Cumulative percentage of households") +
    ylab("Cumulative percentage of total harvest (lb)") +
    scale_y_continuous(limits=c(0,1), labels = scales::percent) + 
    scale_x_continuous(limits=c(0,1), labels = scales::percent) +
    theme(text=element_text(family="serif")) +
    theme(legend.title = element_blank()) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    theme(legend.position="bottom")
  
  print(plotOut)
  
}

```
  


# Write CSV files

```{r write csv files}

# ##############################################################################
# Write out CSV files.
# ##############################################################################

# Write out specialization figure data.
  fName = '../../CSV/05 - Final Analysis Output/specializationFig_raw.csv'
  cat(formatSummaryBlock(
    paste('Writing file: ', fName, 
          ' ', nrow(figData), ' records to be written', sep='')))

  rio::export(figData, fName)

  # Gini coefficient
  fName = '../../CSV/05 - Final Analysis Output/Gini_raw.csv'
  cat(formatSummaryBlock(
    paste('Writing file: ', fName, 
          ' ', nrow(giniAllData), ' records to be written', sep='')))

  rio::export(giniAllData, fName)
  
```

<p class="h1footer"> End of specialization script. </p>
